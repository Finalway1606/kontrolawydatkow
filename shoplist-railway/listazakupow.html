<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopList Pro - Inteligentna Lista Zakupów</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="baza_cen.js"></script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .user-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .user-info i {
            font-size: 24px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .form-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .shopping-list {
            padding: 30px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .list-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .total-cost {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .list-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .item-details {
            color: #666;
            font-size: 0.9rem;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .item-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: #11998e;
            margin-right: 15px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .store-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.8rem;
        }

        .category-badge {
            background: #e9ecef;
            color: #495057;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Responsywność */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-section, .shopping-list {
                padding: 20px;
            }

            .list-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .item-details {
                flex-direction: column;
                gap: 5px;
            }

            .delete-btn {
                align-self: flex-end;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .container {
                border-radius: 10px;
            }
        }

        /* Animacje */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .list-item {
            animation: slideIn 0.3s ease;
        }

        /* Kolory sklepów */
        .store-biedronka { background: #e74c3c; }
        .store-lidl { background: #3498db; }
        .store-kaufland { background: #e67e22; }
        .store-carrefour { background: #2ecc71; }
        .store-auchan { background: #9b59b6; }
        .store-tesco { background: #34495e; }
        .store-aldi { background: #f39c12; }
        .store-zabka { background: #27ae60; }

        /* Style dla współdzielenia */
        .list-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .share-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        .share-section {
            margin-bottom: 30px;
        }

        .share-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .search-user {
            position: relative;
        }

        .search-user input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-user input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .user-info-search {
            display: flex;
            flex-direction: column;
        }

        .user-info-search .username {
            font-weight: 600;
            color: #333;
        }

        .user-info-search .email {
            font-size: 0.9rem;
            color: #666;
        }

        .share-user-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-user-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .shared-users-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .shared-user-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shared-user-info {
            display: flex;
            flex-direction: column;
        }

        .shared-user-info .username {
            font-weight: 600;
            color: #333;
        }

        .shared-user-info .permission {
            font-size: 0.9rem;
            color: #666;
        }

        .permission-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 10px;
        }

        .permission-read {
            background: #e3f2fd;
            color: #1976d2;
        }

        .permission-write {
            background: #e8f5e9;
            color: #388e3c;
        }

        .permission-owner {
            background: #fff3e0;
            color: #f57c00;
        }

        .remove-share-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-share-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .empty-shared {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        /* Styles for product search */
        .product-search-container {
            position: relative;
        }

        .product-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .product-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .product-suggestion:hover {
            background-color: #f8f9fa;
        }

        .product-suggestion:last-child {
            border-bottom: none;
        }

        .product-suggestion .product-name {
            font-weight: 500;
            color: #333;
        }

        .product-suggestion .product-price {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
        }

        .add-new-product {
            padding: 12px;
            background-color: #e8f5e8;
            border-bottom: 1px solid #c3e6c3;
            cursor: pointer;
            font-weight: 500;
            color: #2d5a2d;
        }

        .add-new-product:hover {
            background-color: #d4edda;
        }

        .add-new-product i {
            margin-right: 8px;
            color: #28a745;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .list-actions {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Panel użytkownika -->
        <div class="user-panel">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="username">Użytkownik</span>
            </div>
            <button class="logout-btn" onclick="authManager.logout()">
                <i class="fas fa-sign-out-alt"></i> Wyloguj
            </button>
        </div>

        <div class="header">
            <h1><i class="fas fa-shopping-cart"></i> ShopList Pro</h1>
            <p>Inteligentna lista zakupów z uczeniem się preferencji</p>
        </div>

        <div class="form-section">
            <div class="form-grid">
                <div class="form-group">
                    <label for="sklep"><i class="fas fa-store"></i> Sklep</label>
                    <select id="sklep">
                        <option value="Biedronka">🛒 Biedronka</option>
                        <option value="Lidl">🛒 Lidl</option>
                        <option value="Kaufland">🛒 Kaufland</option>
                        <option value="Carrefour">🛒 Carrefour</option>
                        <option value="Auchan">🛒 Auchan</option>
                        <option value="Tesco">🛒 Tesco</option>
                        <option value="Aldi">🛒 Aldi</option>
                        <option value="Żabka">🛒 Żabka</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kategoria"><i class="fas fa-tags"></i> Kategoria</label>
                    <select id="kategoria">
                        <!-- Kategorie będą załadowane dynamicznie -->
                    </select>
                </div>

                <div class="form-group full-width">
                    <label for="produkt"><i class="fas fa-box"></i> Nazwa produktu</label>
                    <div class="product-search-container">
                        <input type="text" id="produkt" placeholder="Wpisz nazwę produktu lub wybierz z listy" />
                        <div id="productSuggestions" class="product-suggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ilosc"><i class="fas fa-calculator"></i> Ilość</label>
                    <input type="number" id="ilosc" min="1" value="1" />
                </div>

                <div class="form-group">
                    <label for="gramatura"><i class="fas fa-weight"></i> Gramatura/Objętość</label>
                    <input type="text" id="gramatura" placeholder="np. 1L, 500g, 250ml" />
                </div>

                <div class="form-group full-width">
                    <label for="cena"><i class="fas fa-money-bill-wave"></i> Kwota (zł)</label>
                    <input type="number" id="cena" step="0.01" placeholder="Kwota zostanie zasugerowana automatycznie" />
                </div>
            </div>

            <button class="add-btn" onclick="dodajProdukt()">
                <i class="fas fa-plus"></i> Dodaj do listy
            </button>
        </div>

        <div class="shopping-list">
            <div class="list-header">
                <h2><i class="fas fa-list"></i> Twoja lista zakupów</h2>
                <div class="list-actions">
                    <button class="share-btn" onclick="openShareModal()">
                        <i class="fas fa-share-alt"></i> Udostępnij
                    </button>
                    <div class="total-cost" id="totalCost">
                        <i class="fas fa-calculator"></i> 0,00 zł
                    </div>
                </div>
            </div>
            <div id="lista"></div>
        </div>
    </div>

    <script>
        // Sprawdź autentykację przy załadowaniu strony
        document.addEventListener('DOMContentLoaded', async function() {
            // Sprawdź czy użytkownik jest zalogowany
            if (!authManager.requireAuth()) {
                return;
            }

            // Waliduj token
            const isValid = await authManager.validateToken();
            if (!isValid) {
                return;
            }

            // Wyświetl informacje o użytkowniku
            const user = authManager.getUser();
            document.getElementById('username').textContent = user.username;

            // Załaduj dane
            await loadUserData();
        });

        // Zmienne globalne
        let lista = [];
        let bazaProduktow = {};
        let currentListId = null;

        // Funkcja ładowania danych użytkownika
        async function loadUserData() {
            try {
                // Załaduj kategorie produktów
                await loadCategories();
                
                // Załaduj ceny użytkownika z serwera
                const userPrices = await apiManager.getUserPrices();
                
                // Przekształć dane do formatu lokalnej bazy
                bazaProduktow = {};
                userPrices.forEach(price => {
                    const klucz = `${price.product.toLowerCase()}_${price.category.toLowerCase()}`;
                    if (!bazaProduktow[klucz]) {
                        bazaProduktow[klucz] = [];
                    }
                    bazaProduktow[klucz].push(price.price);
                });

                // Załaduj listę zakupów
                await loadUserLists();

                // Dodaj event listener dla wyszukiwania produktów
                setupProductSearch();

                renderujListe();
            } catch (error) {
                console.error('Błąd ładowania danych:', error);
                showNotification('Błąd ładowania danych: ' + error.message, 'error');
            }
        }

        async function loadUserLists() {
            try {
                const lists = await apiManager.getLists();
                if (lists.length > 0) {
                    currentListId = lists[0].id;
                    const items = await apiManager.getListItems(currentListId);
                    lista = items;
                } else {
                    // Utwórz domyślną listę
                    const newList = await apiManager.createList('Moja lista zakupów');
                    currentListId = newList.id;
                    lista = [];
                }
            } catch (error) {
                console.error('Błąd ładowania list:', error);
                showNotification('Błąd ładowania list zakupów', 'error');
            }
        }

        // Funkcja ładowania kategorii
        async function loadCategories() {
            try {
                const categories = await apiManager.getCategories();
                const categorySelect = document.getElementById('kategoria');
                categorySelect.innerHTML = '';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = `${category.icon} ${category.name}`;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Błąd ładowania kategorii:', error);
                showNotification('Błąd ładowania kategorii', 'error');
            }
        }

        // Funkcja konfiguracji wyszukiwania produktów
        function setupProductSearch() {
            const productInput = document.getElementById('produkt');
            const suggestionsDiv = document.getElementById('productSuggestions');
            let searchTimeout;

            productInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    await searchProducts(query);
                }, 300);
            });

            // Ukryj sugestie gdy kliknięto poza elementem
            document.addEventListener('click', function(e) {
                if (!productInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // Funkcja wyszukiwania produktów
        async function searchProducts(query) {
            try {
                const category = document.getElementById('kategoria').value;
                const products = await apiManager.searchProducts(query, category);
                const suggestionsDiv = document.getElementById('productSuggestions');
                
                suggestionsDiv.innerHTML = '';
                
                if (products.length > 0) {
                    products.forEach(product => {
                        const suggestion = document.createElement('div');
                        suggestion.className = 'product-suggestion';
                        suggestion.innerHTML = `
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">Średnia cena: ${product.average_price ? product.average_price.toFixed(2) + ' zł' : 'Brak danych'}</div>
                        `;
                        suggestion.addEventListener('click', () => {
                            selectProduct(product);
                        });
                        suggestionsDiv.appendChild(suggestion);
                    });
                }
                
                // Dodaj opcję dodania nowego produktu
                const addNewDiv = document.createElement('div');
                addNewDiv.className = 'add-new-product';
                addNewDiv.innerHTML = `<i class="fas fa-plus"></i> Dodaj nowy produkt: "${query}"`;
                addNewDiv.addEventListener('click', () => {
                    addNewProduct(query);
                });
                suggestionsDiv.appendChild(addNewDiv);
                
                suggestionsDiv.style.display = 'block';
            } catch (error) {
                console.error('Błąd wyszukiwania produktów:', error);
            }
        }

        // Funkcja wyboru produktu z listy
        function selectProduct(product) {
            document.getElementById('produkt').value = product.name;
            document.getElementById('productSuggestions').style.display = 'none';
            
            // Zasugeruj cenę jeśli dostępna
            if (product.average_price) {
                document.getElementById('cena').value = product.average_price.toFixed(2);
            }
        }

        // Funkcja dodania nowego produktu
        async function addNewProduct(productName) {
            const category = document.getElementById('kategoria').value;
            const price = parseFloat(document.getElementById('cena').value) || 0;
            
            if (price <= 0) {
                showNotification('Proszę podać cenę dla nowego produktu', 'error');
                return;
            }
            
            try {
                await apiManager.addProduct(productName, category, price);
                document.getElementById('produkt').value = productName;
                document.getElementById('productSuggestions').style.display = 'none';
                showNotification('Nowy produkt został dodany do bazy!', 'success');
            } catch (error) {
                console.error('Błąd dodawania produktu:', error);
                showNotification('Błąd dodawania produktu: ' + error.message, 'error');
            }
        }

        // Kolory sklepów
        const storeColors = {
            'Biedronka': 'store-biedronka',
            'Lidl': 'store-lidl',
            'Kaufland': 'store-kaufland',
            'Carrefour': 'store-carrefour',
            'Auchan': 'store-auchan',
            'Tesco': 'store-tesco',
            'Aldi': 'store-aldi',
            'Żabka': 'store-zabka'
        };

        // Funkcja dodawania produktu
        async function dodajProdukt() {
            const sklep = document.getElementById('sklep').value;
            const kategoria = document.getElementById('kategoria').value;
            const produkt = document.getElementById('produkt').value.trim();
            const ilosc = parseInt(document.getElementById('ilosc').value) || 1;
            const gramatura = document.getElementById('gramatura').value.trim();
            const cena = parseFloat(document.getElementById('cena').value) || 0;

            if (!produkt) {
                showNotification('Proszę wpisać nazwę produktu!', 'error');
                return;
            }

            try {
                // Dodaj produkt do listy na serwerze
                 const nowyProdukt = await apiManager.addItemToList(currentListId, {
                     store: sklep,
                     category: kategoria,
                     product: produkt,
                     quantity: ilosc,
                     grammage: gramatura,
                     price: cena
                 });

                // Dodaj do lokalnej listy
                lista.push({
                    id: nowyProdukt.id,
                    sklep,
                    kategoria,
                    produkt,
                    ilosc,
                    gramatura,
                    cena
                });
                
                // Zapisz cenę do bazy uczenia się (lokalnie i na serwerze)
                if (cena > 0) {
                    const klucz = `${produkt.toLowerCase()}_${kategoria.toLowerCase()}`;
                    if (!bazaProduktow[klucz]) {
                        bazaProduktow[klucz] = [];
                    }
                    bazaProduktow[klucz].push(cena);
                    
                    // Zachowaj tylko ostatnie 10 cen
                     if (bazaProduktow[klucz].length > 10) {
                         bazaProduktow[klucz] = bazaProduktow[klucz].slice(-10);
                     }
                 }

                // Wyczyść formularz
                document.getElementById('produkt').value = '';
                document.getElementById('gramatura').value = '';
                document.getElementById('cena').value = '';
                document.getElementById('ilosc').value = '1';

                renderujListe();
                showNotification('Produkt dodany do listy!', 'success');
            } catch (error) {
                console.error('Błąd dodawania produktu:', error);
                showNotification('Błąd dodawania produktu: ' + error.message, 'error');
            }
        }

        // Funkcja renderowania listy
        function renderujListe() {
            const container = document.getElementById('lista');
            
            if (lista.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-basket"></i>
                        <h3>Lista jest pusta</h3>
                        <p>Dodaj pierwszy produkt do swojej listy zakupów</p>
                    </div>
                `;
                updateTotalCost();
                return;
            }

            container.innerHTML = lista.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-name">
                            <span class="store-icon ${storeColors[item.sklep]}">${item.sklep.charAt(0)}</span>
                            ${item.produkt}
                        </div>
                        <div class="item-details">
                            <span class="category-badge">${item.kategoria}</span>
                            ${item.gramatura ? `<span><i class="fas fa-weight"></i> ${item.gramatura}</span>` : ''}
                            <span><i class="fas fa-calculator"></i> ${item.ilosc} szt.</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        ${item.cena > 0 ? `<div class="item-price">${(item.cena * item.ilosc).toFixed(2)} zł</div>` : '<div class="item-price">? zł</div>'}
                        <button class="delete-btn" onclick="usunProdukt(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            updateTotalCost();
        }

        // Funkcja usuwania produktu
        async function usunProdukt(id) {
            try {
                await apiManager.deleteItemFromList(currentListId, id);
                lista = lista.filter(item => item.id !== id);
                renderujListe();
                showNotification('Produkt usunięty z listy!', 'success');
            } catch (error) {
                console.error('Błąd usuwania produktu:', error);
                showNotification('Błąd usuwania produktu: ' + error.message, 'error');
            }
        }

        // Funkcja aktualizacji całkowitego kosztu
        function updateTotalCost() {
            const total = lista.reduce((sum, item) => {
                return sum + (item.cena * item.ilosc);
            }, 0);
            
            document.getElementById('totalCost').innerHTML = `
                <i class="fas fa-calculator"></i> ${total.toFixed(2)} zł
            `;
        }

        // Funkcja sugerowania ceny
         function sugerujCene() {
             const produkt = document.getElementById('produkt').value.trim();
             const kategoria = document.getElementById('kategoria').value;
             const sklep = document.getElementById('sklep').value;
             const klucz = `${produkt.toLowerCase()}_${kategoria.toLowerCase()}`;

             let sugerowanaCena = null;

             // Najpierw sprawdź bazę uczenia się użytkownika
             if (bazaProduktow[klucz] && bazaProduktow[klucz].length > 0) {
                 const srednia = bazaProduktow[klucz].reduce((a, b) => a + b, 0) / bazaProduktow[klucz].length;
                 sugerowanaCena = srednia.toFixed(2);
             }
             // Jeśli nie ma w bazie użytkownika, sprawdź bazę cen sklepów
             else if (typeof pobierzSredniaCene !== 'undefined') {
                 const cenaBazy = pobierzSredniaCene(produkt, kategoria, sklep);
                 if (cenaBazy) {
                     sugerowanaCena = cenaBazy.toFixed(2);
                 } else {
                     // Spróbuj znaleźć podobny produkt
                     const podobnyProdukt = znajdzPodobnyProdukt(produkt, kategoria);
                     if (podobnyProdukt) {
                         const cenaPodobnego = pobierzSredniaCene(podobnyProdukt, kategoria, sklep);
                         if (cenaPodobnego) {
                             sugerowanaCena = cenaPodobnego.toFixed(2);
                         }
                     }
                 }
             }

             if (sugerowanaCena) {
                 document.getElementById('cena').value = sugerowanaCena;
                 document.getElementById('cena').style.background = '#e8f5e8';
                 document.getElementById('cena').style.border = '2px solid #28a745';
                 
                 // Pokaż informację o źródle ceny
                 const cenaInput = document.getElementById('cena');
                 const originalPlaceholder = cenaInput.placeholder;
                 
                 if (bazaProduktow[klucz] && bazaProduktow[klucz].length > 0) {
                     cenaInput.placeholder = `💡 Cena z Twoich zakupów`;
                 } else {
                     cenaInput.placeholder = `💡 Cena z bazy ${sklep}`;
                 }
                 
                 setTimeout(() => {
                     document.getElementById('cena').style.background = 'white';
                     document.getElementById('cena').style.border = '2px solid #e9ecef';
                     cenaInput.placeholder = originalPlaceholder;
                 }, 2000);
             }
         }

        // Event listenery - dodaj po załadowaniu DOM
        document.addEventListener('DOMContentLoaded', function() {
            // Event listenery dla sugerowania cen
            document.getElementById('produkt').addEventListener('blur', sugerujCene);
            document.getElementById('kategoria').addEventListener('change', sugerujCene);
            document.getElementById('sklep').addEventListener('change', sugerujCene);

            // Obsługa Enter w formularzu
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    dodajProdukt();
                }
            });
        });

        // Funkcja wyświetlania powiadomień
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            // Dodaj style dla powiadomień
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Dodaj style animacji
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes slideOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }
        `;
        document.head.appendChild(style);

        // Funkcje współdzielenia
        let searchTimeout;

        function openShareModal() {
            document.getElementById('shareModal').style.display = 'block';
            loadSharedUsers();
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
            document.getElementById('userSearch').value = '';
            document.getElementById('userSearchResults').style.display = 'none';
        }

        // Zamknij modal po kliknięciu poza nim
        window.onclick = function(event) {
            const modal = document.getElementById('shareModal');
            if (event.target === modal) {
                closeShareModal();
            }
        }

        // Wyszukiwanie użytkowników
        document.addEventListener('DOMContentLoaded', function() {
            const userSearchInput = document.getElementById('userSearch');
            if (userSearchInput) {
                userSearchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    const query = this.value.trim();
                    
                    if (query.length < 2) {
                        document.getElementById('userSearchResults').style.display = 'none';
                        return;
                    }
                    
                    searchTimeout = setTimeout(() => {
                        searchUsers(query);
                    }, 300);
                });
            }
        });

        async function searchUsers(query) {
            try {
                const users = await apiManager.searchUsers(query);
                displaySearchResults(users);
            } catch (error) {
                console.error('Błąd wyszukiwania użytkowników:', error);
                showNotification('Błąd wyszukiwania użytkowników', 'error');
            }
        }

        function displaySearchResults(users) {
            const resultsContainer = document.getElementById('userSearchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">Nie znaleziono użytkowników</div>';
            } else {
                resultsContainer.innerHTML = users.map(user => `
                    <div class="search-result-item">
                        <div class="user-info-search">
                            <div class="username">${user.username}</div>
                            <div class="email">${user.email}</div>
                        </div>
                        <button class="share-user-btn" onclick="shareWithUser(${user.id}, '${user.username}')">
                            <i class="fas fa-share"></i> Udostępnij
                        </button>
                    </div>
                `).join('');
            }
            
            resultsContainer.style.display = 'block';
        }

        async function shareWithUser(userId, username) {
            try {
                await apiManager.shareList(currentListId, userId, 'write');
                showNotification(`Lista została udostępniona użytkownikowi ${username}`, 'success');
                document.getElementById('userSearch').value = '';
                document.getElementById('userSearchResults').style.display = 'none';
                loadSharedUsers();
            } catch (error) {
                console.error('Błąd udostępniania listy:', error);
                showNotification('Błąd udostępniania listy: ' + error.message, 'error');
            }
        }

        async function loadSharedUsers() {
            try {
                const sharedUsers = await apiManager.getSharedUsers(currentListId);
                displaySharedUsers(sharedUsers);
            } catch (error) {
                console.error('Błąd ładowania współdzielonych użytkowników:', error);
                document.getElementById('sharedUsersList').innerHTML = '<div class="empty-shared">Błąd ładowania danych</div>';
            }
        }

        function displaySharedUsers(sharedUsers) {
            const container = document.getElementById('sharedUsersList');
            
            if (sharedUsers.length === 0) {
                container.innerHTML = '<div class="empty-shared">Lista nie jest z nikim współdzielona</div>';
                return;
            }
            
            container.innerHTML = sharedUsers.map(shared => `
                <div class="shared-user-item">
                    <div class="shared-user-info">
                        <div class="username">
                            ${shared.username}
                            <span class="permission-badge permission-${shared.permission}">
                                ${shared.permission === 'read' ? 'Tylko odczyt' : 'Edycja'}
                            </span>
                        </div>
                        <div class="permission">
                            Udostępnione przez: ${shared.shared_by_username}
                        </div>
                    </div>
                    <button class="remove-share-btn" onclick="removeSharing(${shared.id}, '${shared.username}')">
                        <i class="fas fa-times"></i> Usuń
                    </button>
                </div>
            `).join('');
        }

        async function removeSharing(shareId, username) {
            if (!confirm(`Czy na pewno chcesz usunąć udostępnienie dla użytkownika ${username}?`)) {
                return;
            }
            
            try {
                await apiManager.removeSharing(currentListId, shareId);
                showNotification(`Udostępnienie dla ${username} zostało usunięte`, 'success');
                loadSharedUsers();
            } catch (error) {
                console.error('Błąd usuwania udostępnienia:', error);
                showNotification('Błąd usuwania udostępnienia: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Modal współdzielenia -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-share-alt"></i> Udostępnij listę zakupów</h3>
                <span class="close" onclick="closeShareModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="share-section">
                    <h4>Dodaj użytkownika</h4>
                    <div class="search-user">
                        <input type="text" id="userSearch" placeholder="Wpisz nazwę użytkownika lub email..." />
                        <div id="userSearchResults" class="search-results"></div>
                    </div>
                </div>
                
                <div class="share-section">
                    <h4>Współdzielone z:</h4>
                    <div id="sharedUsersList" class="shared-users-list">
                        <div class="loading">Ładowanie...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
