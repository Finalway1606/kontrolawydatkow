<!DOCTYPE html>
<html lang="pl">
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budżet Domowy</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e1e;
      color: #d4af37;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    section {
      background: #2c2c2c;
      padding: 1rem 2rem;
      margin-bottom: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
      border: 1px solid #d4af37;
    }
    h1, h2 {
      text-align: center;
      color: #ffd966;
      margin-bottom: 0.5rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
      color: #ffd966;
    }
    input, select {
      width: 100%;
      max-width: 350px;
      box-sizing: border-box;
      padding: 0.5rem 0.8rem;
      margin-top: 0.3rem;
      border-radius: 6px;
      border: 1px solid #d4af37;
      background: #3b3b3b;
      color: #ffd966;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      display: block;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #ffd966;
      background: #444;
      color: #fff;
    }
    button {
      margin-top: 1.2rem;
      padding: 0.6rem 1.2rem;
      background: #d4af37;
      color: #1e1e1e;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      display: block;
      width: 100%;
      max-width: 240px;
      margin-left: auto;
      margin-right: auto;
    }
    button:hover {
      background: #ffd966;
      color: #1a1a1a;
    }
    .result {
      font-size: 1.1rem;
      font-weight: bold;
      white-space: pre-wrap;
      color: #fff3b0;
      background: #3b3b3b;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #d4af37;
      margin-top: 1rem;
    }
    ul {
      padding-left: 1.5rem;
      color: #f0d77a;
      max-height: 150px;
      overflow-y: auto;
      margin-top: 0.5rem;
      border: 1px solid #d4af37;
      border-radius: 8px;
      background: #3b3b3b;
    }

    /* Responsywność */
    @media (max-width: 480px) {
      body {
        padding: 1rem;
      }
      section {
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      button {
        max-width: 100%;
      }
      input, select {
        font-size: 1.1rem;
      }
      label {
        font-size: 1rem;
      }
      h1 {
        font-size: 1.8rem;
      }
      h2 {
        font-size: 1.4rem;
      }
      .result {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <h1>Budżet Domowy</h1>

  <section>
    <h2>Wpływy</h2>
    <label for="salaryInput">Pensja:</label>
    <input type="number" id="salaryInput" />

    <label for="childInput">800+:</label>
    <input type="number" id="childInput" />
  </section>

  <section>
    <h2>Wydatki stałe</h2>
    <label for="creditInput">Rata kredytu:</label>
    <input type="number" id="creditInput" />

    <label for="internetInput">Internet:</label>
    <input type="number" id="internetInput" />

    <label for="phoneInput">Telefony:</label>
    <input type="number" id="phoneInput" />

    <label for="allowanceInput">Kieszonkowe:</label>
    <input type="number" id="allowanceInput" />

    <label for="rentInput">Czynsz:</label>
    <input type="number" id="rentInput" />

    <label for="electricityInput">Prąd:</label>
    <input type="number" id="electricityInput" />

    <label for="zusInput">ZUS:</label>
    <input type="number" id="zusInput" />

    <label for="accountantInput">Księgowa:</label>
    <input type="number" id="accountantInput" />

    <label for="eagonInput">Eagon:</label>
    <input type="number" id="eagonInput" />

    <label for="kindergartenInput">Przedszkole:</label>
    <input type="number" id="kindergartenInput" />

    <label for="spentAlreadyInput">Wydatki już poniesione (np. zakupy):</label>
    <input type="number" id="spentAlreadyInput" />
  </section>

  <section>
    <h2>Subskrypcje</h2>
    <label for="netflixInput">Netflix (miesięcznie):</label>
    <input type="number" id="netflixInput" />

    <label for="primeInput">Prime (miesięcznie):</label>
    <input type="number" id="primeInput" />

    <label for="disneyInput">Disney+ (rocznie):</label>
    <input type="number" id="disneyInput" />

    <label for="xboxInput">Xbox (miesięcznie):</label>
    <input type="number" id="xboxInput" />
  </section>

  <section>
    <h2>Wydatki ad hoc, uzupełniane po każdym zakupie</h2>
    <label for="expenseCategory">Kategoria:</label>
    <select id="expenseCategory" onchange="categoryChanged()">
      <option value="">-- Wybierz kategorię --</option>
      <option value="spozywka">Spożywka</option>
      <option value="zarcie">Żarcie na dowóz</option>
      <option value="przyjemnosci">Przyjemności</option>
    </select>

    <label id="subcategoryLabel" style="display:none; margin-top: 1rem;" for="expenseSubcategory">Podkategoria:</label>
    <select id="expenseSubcategory" style="display:none;">
      <option value="">-- Wybierz podkategorię --</option>
      <option value="zabka">Żabka</option>
      <option value="auchan">Auchan</option>
    </select>

    <label for="expenseDesc">Opis wydatku:</label>
    <input type="text" id="expenseDesc" />
    <label for="expenseAmount">Kwota wydatku:</label>
    <input type="number" id="expenseAmount" />
    <button onclick="addExpense()">➕ Dodaj wydatek</button>
  </section>

  <section>
    <h2>Podsumowanie</h2>
    <p id="summaryText" class="result"></p>
    <h3>Wydatki ad hoc:</h3>
    <ul id="expenseList"></ul>
    <button onclick="resetBin()">🧹 Resetuj dane (ostrzeżenie!)</button>
  </section>

  <div style="text-align:center; margin-top:2rem;">
    <button onclick="saveData()">💾 Zapisz dane</button>
  </div>

  <script>
    const binId = "688a2a2c7b4b8670d8a9e071";
    const masterKey = "$2a$10$PrRx.RBOnJmEFTqQQLH/Tu8TXFwoNEI.j/XEFF19EYFYELKzSX9BC";
    const apiUrl = `https://api.jsonbin.io/v3/b/${binId}`;

    let data = {
      incomeSources: { salary: 0, childSupport: 0 },
      fixedExpenses: {
        credit: 0,
        internet: 0,
        phone: 0,
        allowance: 0,
        rent: 0,
        electricity: 0,
        zus: 0,
        accountant: 0,
        eagon: 0,
        kindergarten: 0
      },
      subscriptions: { netflix: 0, prime: 0, disney: 0, xbox: 0 },
      spentAlready: 0,
      expenses: []
    };

    function categoryChanged() {
      const cat = document.getElementById('expenseCategory').value;
      const subcatLabel = document.getElementById('subcategoryLabel');
      const subcatSelect = document.getElementById('expenseSubcategory');
      if(cat === 'spozywka') {
        subcatLabel.style.display = 'block';
        subcatSelect.style.display = 'block';
      } else {
        subcatLabel.style.display = 'none';
        subcatSelect.style.display = 'none';
        subcatSelect.value = "";
      }
    }

    async function loadData() {
      try {
        const res = await fetch(apiUrl, {
          headers: { "X-Master-Key": masterKey }
        });
        const json = await res.json();
        data = json.record;
        updateForm();
        updateSummary();
      } catch (e) {
        alert("❌ Błąd pobierania: " + e.message);
      }
    }

    function updateForm() {
      document.getElementById('salaryInput').value = data.incomeSources?.salary || 0;
      document.getElementById('childInput').value = data.incomeSources?.childSupport || 0;
      document.getElementById('creditInput').value = data.fixedExpenses?.credit || 0;
      document.getElementById('internetInput').value = data.fixedExpenses?.internet || 0;
      document.getElementById('phoneInput').value = data.fixedExpenses?.phone || 0;
      document.getElementById('allowanceInput').value = data.fixedExpenses?.allowance || 0;
      document.getElementById('rentInput').value = data.fixedExpenses?.rent || 0;
      document.getElementById('electricityInput').value = data.fixedExpenses?.electricity || 0;
      document.getElementById('zusInput').value = data.fixedExpenses?.zus || 0;
      document.getElementById('accountantInput').value = data.fixedExpenses?.accountant || 0;
      document.getElementById('eagonInput').value = data.fixedExpenses?.eagon || 0;
      document.getElementById('kindergartenInput').value = data.fixedExpenses?.kindergarten || 0;
      document.getElementById('spentAlreadyInput').value = data.spentAlready || 0;

      document.getElementById('netflixInput').value = data.subscriptions?.netflix || 0;
      document.getElementById('primeInput').value = data.subscriptions?.prime || 0;
      document.getElementById('disneyInput').value = data.subscriptions?.disney || 0;
      document.getElementById('xboxInput').value = data.subscriptions?.xbox || 0;

      updateExpenseList();
    }

    function updateExpenseList() {
      const ul = document.getElementById('expenseList');
      ul.innerHTML = '';
      (data.expenses || []).forEach((e, index) => {
        const li = document.createElement('li');
        li.style.marginBottom = '0.5rem';

        const descDiv = document.createElement('div');
        let displayText = e.desc + ': ' + e.amount.toFixed(2) + ' zł';
        if(e.category) displayText += ` [${e.category}${e.subcategory ? ' > ' + e.subcategory : ''}]`;
        descDiv.textContent = displayText;
        descDiv.style.marginBottom = '0.3rem';

        const btn = document.createElement('button');
        btn.textContent = 'Usuń';
        btn.style.width = '100%';
        btn.style.padding = '0.5rem';
        btn.style.backgroundColor = '#b22222';
        btn.style.color = 'white';
        btn.style.border = 'none';
        btn.style.borderRadius = '6px';
        btn.style.cursor = 'pointer';

        btn.onclick = () => {
          removeExpense(index);
        };

        li.appendChild(descDiv);
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function removeExpense(index) {
      data.expenses.splice(index, 1);
      updateExpenseList();
      updateSummary();
      saveData();
    }

    function updateSummary() {
      const income = (data.incomeSources?.salary || 0) + (data.incomeSources?.childSupport || 0);
      const fixed = Object.values(data.fixedExpenses || {}).reduce((a, b) => a + b, 0);

      const subsMonthly = 
        (data.subscriptions?.netflix || 0) +
        (data.subscriptions?.prime || 0) +
        ((data.subscriptions?.disney || 0) / 12) +
        (data.subscriptions?.xbox || 0);

      const adHocExpenses = (data.expenses || []).reduce((sum, e) => sum + e.amount, 0);
      const totalSpent = fixed + subsMonthly + (data.spentAlready || 0) + adHocExpenses;
      const savings = 1000;

      const now = new Date();
      const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();

      const available = income - totalSpent - savings;
      const dailyAvailable = available > 0 ? (available / daysInMonth) : 0;

      const text = 
`Dochód: ${income.toFixed(2)} zł
Stałe wydatki: ${fixed.toFixed(2)} zł
Subskrypcje (miesięcznie przeliczone): ${subsMonthly.toFixed(2)} zł
Wydatki już poniesione: ${(data.spentAlready || 0).toFixed(2)} zł
Wydatki ad hoc: ${adHocExpenses.toFixed(2)} zł
------------------------------------
Razem wydatków: ${totalSpent.toFixed(2)} zł
Oszczędności (zarezerwowane): ${savings.toFixed(2)} zł
Dostępne po wydatkach: ${available.toFixed(2)} zł
Dostępne dziennie: ${dailyAvailable.toFixed(2)} zł
`;

      document.getElementById('summaryText').textContent = text;
    }

    function addExpense() {
      const cat = document.getElementById('expenseCategory').value;
      if(!cat) {
        alert('Wybierz kategorię!');
        return;
      }
      const subcatSelect = document.getElementById('expenseSubcategory');
      const subcat = subcatSelect.style.display !== 'none' ? subcatSelect.value : "";

      const desc = document.getElementById('expenseDesc').value.trim();
      if(!desc) {
        alert('Podaj opis wydatku!');
        return;
      }

      const amount = parseFloat(document.getElementById('expenseAmount').value);
      if(isNaN(amount) || amount <= 0) {
        alert('Podaj poprawną kwotę!');
        return;
      }

      data.expenses.push({ category: cat, subcategory: subcat, desc: desc, amount: amount });
      updateExpenseList();
      updateSummary();

      // Wyczyść pola
      document.getElementById('expenseCategory').value = "";
      document.getElementById('expenseSubcategory').value = "";
      categoryChanged();
      document.getElementById('expenseDesc').value = "";
      document.getElementById('expenseAmount').value = "";
    }

    function resetBin() {
      if(confirm("Czy na pewno chcesz zresetować wszystkie dane?")) {
        data = {
          incomeSources: { salary: 0, childSupport: 0 },
          fixedExpenses: {
            credit: 0,
            internet: 0,
            phone: 0,
            allowance: 0,
            rent: 0,
            electricity: 0,
            zus: 0,
            accountant: 0,
            eagon: 0,
            kindergarten: 0
          },
          subscriptions: { netflix: 0, prime: 0, disney: 0, xbox: 0 },
          spentAlready: 0,
          expenses: []
        };
        updateForm();
        updateSummary();
        saveData();
      }
    }

    async function saveData() {
      // Aktualizuj dane z inputów przed zapisem
      data.incomeSources.salary = parseFloat(document.getElementById('salaryInput').value) || 0;
      data.incomeSources.childSupport = parseFloat(document.getElementById('childInput').value) || 0;

      data.fixedExpenses.credit = parseFloat(document.getElementById('creditInput').value) || 0;
      data.fixedExpenses.internet = parseFloat(document.getElementById('internetInput').value) || 0;
      data.fixedExpenses.phone = parseFloat(document.getElementById('phoneInput').value) || 0;
      data.fixedExpenses.allowance = parseFloat(document.getElementById('allowanceInput').value) || 0;
      data.fixedExpenses.rent = parseFloat(document.getElementById('rentInput').value) || 0;
      data.fixedExpenses.electricity = parseFloat(document.getElementById('electricityInput').value) || 0;
      data.fixedExpenses.zus = parseFloat(document.getElementById('zusInput').value) || 0;
      data.fixedExpenses.accountant = parseFloat(document.getElementById('accountantInput').value) || 0;
      data.fixedExpenses.eagon = parseFloat(document.getElementById('eagonInput').value) || 0;
      data.fixedExpenses.kindergarten = parseFloat(document.getElementById('kindergartenInput').value) || 0;

      data.spentAlready = parseFloat(document.getElementById('spentAlreadyInput').value) || 0;

      data.subscriptions.netflix = parseFloat(document.getElementById('netflixInput').value) || 0;
      data.subscriptions.prime = parseFloat(document.getElementById('primeInput').value) || 0;
      data.subscriptions.disney = parseFloat(document.getElementById('disneyInput').value) || 0;
      data.subscriptions.xbox = parseFloat(document.getElementById('xboxInput').value) || 0;

      try {
        const res = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": masterKey
          },
          body: JSON.stringify(data)
        });
        if(!res.ok) throw new Error(res.statusText);
        alert('✅ Dane zostały zapisane!');
      } catch (e) {
        alert("❌ Błąd zapisu: " + e.message);
      }
      updateSummary();
    }

    window.onload = loadData;
  </script>
</body>
</html>
